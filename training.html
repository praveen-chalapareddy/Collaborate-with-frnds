<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Employee Project Performance Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap for quick layout -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <style>
    body { padding: 18px; background:#f7f9fc; }
    .kpi { border-radius:8px; background:white; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,0.05); }
    .table-wrap { overflow:auto; background: white; padding:12px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    .small-muted { font-size:0.85rem; color:#6b7280; }
    .dt-center { text-align:center; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2>Employee Project Performance Dashboard</h2>
      <div class="small-muted">Based on your dataset schema. :contentReference[oaicite:1]{index=1}</div>
    </div>

    <!-- Filters and KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-md-8">
        <div class="row g-2">
          <div class="col-md-4">
            <select id="projectFilter" class="form-select">
              <option value="">All Projects</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="roleFilter" class="form-select">
              <option value="">All Roles</option>
            </select>
          </div>
          <div class="col-md-3">
            <input id="dateFrom" type="date" class="form-control" placeholder="Start date">
          </div>
          <div class="col-md-2">
            <input id="dateTo" type="date" class="form-control" placeholder="End date">
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="d-flex gap-2 justify-content-end">
          <button id="downloadCsv" class="btn btn-outline-primary">Download CSV</button>
          <button id="resetFilters" class="btn btn-outline-secondary">Reset</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="col-12">
        <div class="row g-3">
          <div class="col-md-3 kpi">
            <div class="small-muted">Avg. Performance</div>
            <div id="kpiAvgPerf" class="fs-4 fw-semibold">—</div>
          </div>
          <div class="col-md-3 kpi">
            <div class="small-muted">Total Tasks Completed</div>
            <div id="kpiTasks" class="fs-4 fw-semibold">—</div>
          </div>
          <div class="col-md-3 kpi">
            <div class="small-muted">Avg. Task Time (days)</div>
            <div id="kpiAvgTaskTime" class="fs-4 fw-semibold">—</div>
          </div>
          <div class="col-md-3 kpi">
            <div class="small-muted">Avg. On-time %</div>
            <div id="kpiOnTime" class="fs-4 fw-semibold">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="row mb-3">
      <div class="col-md-8">
        <div class="card p-3">
          <canvas id="topPerformersChart" height="120"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div class="col-md-4">
        <div class="card p-3">
          <h6>Quick stats</h6>
          <ul id="quickStats" class="list-unstyled small-muted mb-0"></ul>
        </div>
      </div>
    </div>

    <div class="table-wrap mb-5">
      <table id="perfTable" class="display cell-border stripe" style="width:100%">
        <thead>
          <tr>
            <th>employee_id</th><th>employee_name</th><th>project_id</th><th>project_name</th>
            <th>role</th><th>start_date</th><th>end_date</th><th>task_completed</th>
            <th>avg_task_time_days</th><th>performance_score</th><th>on_time_delivery</th>
            <th>bugs_reported</th><th>bugs_fixed</th><th>manager_feedback</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer class="text-muted small">Tip: use the filters above to slice the dataset. You can download the filtered rows as CSV.</footer>
  </div>

  <!-- Dependencies: jQuery, DataTables, Chart.js, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ------------------------
  // Sample dataset (you can replace this with a fetch to your CSV/DB)
  // Schema follows the uploaded dataset definition. :contentReference[oaicite:2]{index=2}
  // ------------------------
  const sampleData = [
    { employee_id:"EMP1023", employee_name:"Durga Mali", project_id:"PRJ2025_07", project_name:"Quantum Job Tracker", role:"Backend Developer", start_date:"2025-07-01", end_date:"2025-09-01", task_completed:24, avg_task_time_days:2.3, performance_score:8.7, on_time_delivery:92, bugs_reported:3, bugs_fixed:7, manager_feedback:"Very consistent performer" },
    { employee_id:"EMP1045", employee_name:"Aryan Singh", project_id:"PRJ2025_07", project_name:"Quantum Job Tracker", role:"Frontend Developer", start_date:"2025-07-05", end_date:"2025-09-01", task_completed:21, avg_task_time_days:2.8, performance_score:7.9, on_time_delivery:85, bugs_reported:5, bugs_fixed:6, manager_feedback:"Needs improvement in deadlines" },
    { employee_id:"EMP1098", employee_name:"Neha Sharma", project_id:"PRJ2025_07", project_name:"Quantum Job Tracker", role:"Project Manager", start_date:"2025-07-01", end_date:"2025-09-01", task_completed:15, avg_task_time_days:3.0, performance_score:9.1, on_time_delivery:95, bugs_reported:1, bugs_fixed:2, manager_feedback:"Excellent leadership" },
    { employee_id:"EMP1102", employee_name:"Ravi Kumar", project_id:"PRJ2025_08", project_name:"Customer Portal", role:"QA Engineer", start_date:"2025-06-15", end_date:"2025-09-05", task_completed:30, avg_task_time_days:1.9, performance_score:8.4, on_time_delivery:90, bugs_reported:6, bugs_fixed:12, manager_feedback:"Good at finding bugs, proactive" },
    { employee_id:"EMP1123", employee_name:"Priya Patel", project_id:"PRJ2025_08", project_name:"Customer Portal", role:"Frontend Developer", start_date:"2025-06-20", end_date:"2025-08-30", task_completed:28, avg_task_time_days:2.1, performance_score:8.2, on_time_delivery:88, bugs_reported:4, bugs_fixed:10, manager_feedback:"Consistent and dependable" },
    { employee_id:"EMP1150", employee_name:"Sanjay Rao", project_id:"PRJ2025_09", project_name:"Data Migration", role:"Backend Developer", start_date:"2025-05-10", end_date:"2025-08-15", task_completed:40, avg_task_time_days:1.7, performance_score:9.0, on_time_delivery:97, bugs_reported:2, bugs_fixed:3, manager_feedback:"High throughput" },
    { employee_id:"EMP1188", employee_name:"Anjali Verma", project_id:"PRJ2025_07", project_name:"Quantum Job Tracker", role:"DevOps", start_date:"2025-07-02", end_date:"2025-09-01", task_completed:18, avg_task_time_days:2.5, performance_score:8.6, on_time_delivery:93, bugs_reported:1, bugs_fixed:1, manager_feedback:"Solid infra skills" },
    { employee_id:"EMP1201", employee_name:"Vikram Joshi", project_id:"PRJ2025_09", project_name:"Data Migration", role:"QA Engineer", start_date:"2025-05-15", end_date:"2025-08-20", task_completed:33, avg_task_time_days:1.8, performance_score:8.1, on_time_delivery:89, bugs_reported:5, bugs_fixed:9, manager_feedback:"Thorough testing" },
    { employee_id:"EMP1212", employee_name:"Meera Iyer", project_id:"PRJ2025_10", project_name:"Mobile App", role:"Frontend Developer", start_date:"2025-08-01", end_date:"2025-09-05", task_completed:12, avg_task_time_days:3.2, performance_score:7.6, on_time_delivery:80, bugs_reported:3, bugs_fixed:2, manager_feedback:"Learning curve" },
    { employee_id:"EMP1234", employee_name:"Rohan Gupta", project_id:"PRJ2025_10", project_name:"Mobile App", role:"Backend Developer", start_date:"2025-08-05", end_date:"2025-09-05", task_completed:14, avg_task_time_days:2.6, performance_score:8.0, on_time_delivery:86, bugs_reported:2, bugs_fixed:5, manager_feedback:"Reliable contributor" }
  ];

  // Utility: convert numeric percent fields if needed
  const normData = sampleData.map(r => ({ ...r, on_time_delivery: Number(r.on_time_delivery) }));

  let dataTable, chart;

  $(document).ready(function() {
    // Populate filters
    const projects = [...new Set(normData.map(d => d.project_name))].sort();
    const roles = [...new Set(normData.map(d => d.role))].sort();

    for (const p of projects) $('#projectFilter').append(`<option value="${p}">${p}</option>`);
    for (const r of roles) $('#roleFilter').append(`<option value="${r}">${r}</option>`);

    // init datatable
    dataTable = $('#perfTable').DataTable({
      data: normData,
      columns: [
        { data: 'employee_id' },
        { data: 'employee_name' },
        { data: 'project_id' },
        { data: 'project_name' },
        { data: 'role' },
        { data: 'start_date' },
        { data: 'end_date' },
        { data: 'task_completed' },
        { data: 'avg_task_time_days' },
        { data: 'performance_score' },
        { data: 'on_time_delivery', render: d => (d==null?'-':d + '%') },
        { data: 'bugs_reported' },
        { data: 'bugs_fixed' },
        { data: 'manager_feedback' }
      ],
      pageLength: 10,
      order: [[9, 'desc']]
    });

    // initial KPIs & chart
    updateKPIsAndChart();

    // Filter events
    $('#projectFilter, #roleFilter, #dateFrom, #dateTo').on('change', applyFilters);
    $('#resetFilters').on('click', () => {
      $('#projectFilter').val(''); $('#roleFilter').val(''); $('#dateFrom').val(''); $('#dateTo').val('');
      applyFilters();
    });

    // Download CSV
    $('#downloadCsv').on('click', () => {
      const rows = getFilteredRows();
      downloadCSV(rows, 'performance_filtered.csv');
    });
  });

  function applyFilters() {
    const project = $('#projectFilter').val();
    const role = $('#roleFilter').val();
    const from = $('#dateFrom').val();
    const to = $('#dateTo').val();

    // custom filter by project/role/date
    $.fn.dataTable.ext.search = []; // reset
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
      const row = dataTable.row(dataIndex).data();
      if (!row) return true;
      if (project && row.project_name !== project) return false;
      if (role && row.role !== role) return false;
      if (from && row.start_date < from) return false;
      if (to && row.end_date > to) return false;
      return true;
    });

    dataTable.draw();
    updateKPIsAndChart();
  }

  function getFilteredRows() {
    // get currently visible rows from DataTable
    const rows = [];
    dataTable.rows({ search: 'applied' }).every(function() {
      rows.push(this.data());
    });
    return rows;
  }

  function updateKPIsAndChart() {
    const rows = getFilteredRows();
    if (rows.length === 0) {
      $('#kpiAvgPerf').text('-'); $('#kpiTasks').text(0); $('#kpiAvgTaskTime').text('-'); $('#kpiOnTime').text('-');
      updateChart([], []);
      $('#quickStats').html('<li>No rows</li>');
      return;
    }

    // Aggregations
    const avgPerf = (rows.reduce((s,r)=> s + Number(r.performance_score||0), 0) / rows.length).toFixed(2);
    const totalTasks = rows.reduce((s,r)=> s + Number(r.task_completed||0), 0);
    const avgTaskTime = (rows.reduce((s,r)=> s + Number(r.avg_task_time_days||0), 0) / rows.length).toFixed(2);
    const avgOnTime = (rows.reduce((s,r)=> s + Number(r.on_time_delivery||0), 0) / rows.length).toFixed(1);

    $('#kpiAvgPerf').text(avgPerf);
    $('#kpiTasks').text(totalTasks);
    $('#kpiAvgTaskTime').text(avgTaskTime);
    $('#kpiOnTime').text(avgOnTime + '%');

    // Top performers (by performance_score)
    const sorted = [...rows].sort((a,b)=> b.performance_score - a.performance_score).slice(0,8);
    const labels = sorted.map(r => r.employee_name + ' ('+ r.employee_id +')');
    const values = sorted.map(r => Number(r.performance_score));

    updateChart(labels, values);

    // quick stats list
    const byProject = {};
    rows.forEach(r => { byProject[r.project_name] = (byProject[r.project_name] || 0) + 1; });
    const statsHtml = [
      `<li><strong>Rows:</strong> ${rows.length}</li>`,
      `<li><strong>Projects in view:</strong> ${Object.keys(byProject).length}</li>`,
      '<li><strong>Rows by project:</strong></li>',
      ...Object.keys(byProject).map(p => `<li class="ps-3">${p}: ${byProject[p]}</li>`)
    ].join('');
    $('#quickStats').html(statsHtml);
  }

  function updateChart(labels, values) {
    const ctx = document.getElementById('topPerformersChart');
    if (chart) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
      return;
    }
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Performance Score',
          data: values,
          // Chart.js default colors will be used
          borderRadius: 6,
          barThickness: 24
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 10 }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  // CSV download helper
  function downloadCSV(rows, filename) {
    if (!rows || rows.length === 0) return alert('No rows to download');
    const keys = Object.keys(rows[0]);
    const csv = [
      keys.join(','),
      ...rows.map(r => keys.map(k => {
        const v = r[k] === undefined || r[k] === null ? '' : String(r[k]);
        // escape quotes
        return '"' + v.replace(/"/g, '""') + '"';
      }).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }
  </script>
</body>
</html>
